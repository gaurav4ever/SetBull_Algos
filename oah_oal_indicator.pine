//@version=5
indicator("SETBULL-DAILY", overlay=true)

// .....................................................................
// >5% OAH OAL INDICATOR
// .....................................................................

prev_high = ta.highest(high[1], 1)
prev_low = ta.lowest(low[1], 1)
prev_60pct = prev_low + ((prev_high - prev_low) * 0.6)

// OAH Selling Pattern
is_oah_selling = open > prev_60pct and close < open

// OAL Buying Pattern
is_oal_buying = open < prev_60pct and close > open

// Using lighter colors
light_red = color.new(color.red, 63)   
light_green = color.new(color.green, 63)

// Plot patterns
plotshape(is_oah_selling, style=shape.triangledown, location=location.abovebar, color=light_red, size=size.small)
plotshape(is_oal_buying, style=shape.triangleup, location=location.belowbar, color=light_green, size=size.small)

// Alert conditions
alertcondition(is_oah_selling, message="OAH Selling pattern detected")
alertcondition(is_oal_buying, message="OAL Buying pattern detected")

// .....................................................................
// >5% PRICE MOVEMENT INDICATOR
// .....................................................................

// Input for customizing the percentage threshold
var pctChange = input.float(title="Percentage Move Threshold", defval=5.0, minval=0.1, step=0.1)

// Calculate percentage change from open to close
percentMove = ((close - open) / open) * 100

// Determine significant moves
isBigUpMove = percentMove >= pctChange
isBigDownMove = percentMove <= -pctChange

// Plot arrows for significant moves
plotarrow(isBigUpMove ? 1 : na, title="Up Move", colorup=color.green, maxheight=25, minheight=25)
plotarrow(isBigDownMove ? -1 : na, title="Down Move", colordown=color.red, maxheight=25, minheight=25)

// .....................................................................
// >5% TREND QUALITY INDICATOR
// .....................................................................

// Constants
var LOOKBACK_PERIOD = 10
var EMA_LENGTH = 9

// Calculate 9 EMA
ema9 = ta.ema(close, EMA_LENGTH)

// Function to analyze bullish trend quality
isBullishQualityTrend() =>
    var int belowEmaCount = 0
    var bool allAboveEma = true
    var bool hadValidPullback = false
    
    // Reset for new calculation
    belowEmaCount := 0
    allAboveEma := true
    hadValidPullback := false
    
    // Analyze last 10 days
    for i = 1 to LOOKBACK_PERIOD
        if close[i] < ema9[i]
            belowEmaCount := belowEmaCount + 1
            allAboveEma := false
            
            // If we see price back above EMA after being below, mark valid pullback
            if i > 1 and close[i-1] > ema9[i-1]
                hadValidPullback := true
    
    // Conditions for bullish quality trend
    isValid = close > ema9 and 
             (allAboveEma or hadValidPullback) and 
             belowEmaCount <= 3    // Allow max 3 days below EMA

    isValid

// Function to analyze bearish trend quality
isBearishQualityTrend() =>
    var int aboveEmaCount = 0
    var bool allBelowEma = true
    var bool hadValidRally = false
    
    // Reset for new calculation
    aboveEmaCount := 0
    allBelowEma := true
    hadValidRally := false
    
    // Analyze last 10 days
    for i = 1 to LOOKBACK_PERIOD
        if close[i] > ema9[i]
            aboveEmaCount := aboveEmaCount + 1
            allBelowEma := false
            
            // If we see price back below EMA after being above, mark valid rally
            if i > 1 and close[i-1] < ema9[i-1]
                hadValidRally := true
    
    // Conditions for bearish quality trend
    isValid = close < ema9 and 
             (allBelowEma or hadValidRally) and 
             aboveEmaCount <= 3    // Allow max 3 days above EMA

    isValid

// Plot conditions only on the last bar
if barstate.islast
    if isBullishQualityTrend()
        label.new(bar_index, high, "✓", color=color.blue, style=label.style_label_down, textcolor=color.white, size=size.normal)
    if isBearishQualityTrend()
        label.new(bar_index, low, "✓", color=color.red, style=label.style_label_up, textcolor=color.white, size=size.normal)
